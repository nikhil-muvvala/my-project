<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VAHAN Automation Portal</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-width: 900px;
            margin: 0 auto;
            padding: 40px;
        }
        h1 { color: #1a237e; text-align: center; margin-bottom: 10px; font-size: 28px; }
        .subtitle { text-align: center; color: #666; margin-bottom: 40px; font-size: 14px; }
        .task-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .task-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 10px;
            padding: 25px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
        }
        .task-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        .task-card.selected { border-color: #1a237e; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); }
        .task-icon { font-size: 45px; margin-bottom: 12px; }
        .task-card h3 { color: #1a237e; font-size: 15px; margin-bottom: 6px; }
        .task-card p { color: #666; font-size: 12px; }
        .form-section {
            display: none;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 25px;
            margin-top: 30px;
        }
        .form-section.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .form-group { margin-bottom: 18px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 600; color: #333; font-size: 14px; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #1a237e;
        }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .btn {
            background: #1a237e;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 10px;
        }
        .btn:hover { background: #283593; transform: translateY(-2px); }
        .btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .status-message {
            padding: 12px;
            border-radius: 6px;
            margin-top: 15px;
            display: none;
            font-size: 13px;
        }
        .status-message.show { display: block; }
        .status-message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status-message.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .captcha-container {
            text-align: center;
            margin: 20px 0;
        }
        .captcha-image {
            max-width: 300px;
            border: 2px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            background: white;
        }
        .result-box {
            background: white;
            padding: 20px;
            border-radius: 6px;
            margin-top: 15px;
            border-left: 4px solid #4caf50;
        }
        .result-box h4 { color: #1a237e; margin-bottom: 15px; font-size: 16px; }
        .result-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .result-table td {
            padding: 8px;
            border-bottom: 1px solid #e0e0e0;
        }
        .result-table td:first-child {
            font-weight: 600;
            color: #666;
            width: 40%;
        }
        h4 { color: #1a237e; margin: 15px 0 10px; font-size: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöó VAHAN Automation Portal</h1>
        <p class="subtitle">Select a task and follow the step-by-step process</p>

        <div class="task-grid">
            <div class="task-card" onclick="selectTask('search')">
                <div class="task-icon">üîç</div>
                <h3>Know Your Vehicle</h3>
                <p>Search vehicle details</p>
            </div>
            <div class="task-card" onclick="selectTask('register')">
                <div class="task-icon">üìã</div>
                <h3>Vehicle Registration</h3>
                <p>Register new vehicle</p>
            </div>
            <div class="task-card" onclick="selectTask('transfer')">
                <div class="task-icon">üîÑ</div>
                <h3>Transfer Ownership</h3>
                <p>Transfer vehicle</p>
            </div>
            <div class="task-card" onclick="selectTask('update')">
                <div class="task-icon">‚úèÔ∏è</div>
                <h3>Update Contacts</h3>
                <p>Update contact details</p>
            </div>
        </div>

        <div class="form-section" id="formSection"></div>
    </div>

    <script>
        let selectedTask = null;
        let sessionData = {};

        const indianStates = [
            { code: 'AP', name: 'Andhra Pradesh' }, { code: 'AR', name: 'Arunachal Pradesh' },
            { code: 'AS', name: 'Assam' }, { code: 'BR', name: 'Bihar' },
            { code: 'CG', name: 'Chhattisgarh' }, { code: 'GA', name: 'Goa' },
            { code: 'GJ', name: 'Gujarat' }, { code: 'HR', name: 'Haryana' },
            { code: 'HP', name: 'Himachal Pradesh' }, { code: 'JK', name: 'Jammu and Kashmir' },
            { code: 'JH', name: 'Jharkhand' }, { code: 'KA', name: 'Karnataka' },
            { code: 'KL', name: 'Kerala' }, { code: 'MP', name: 'Madhya Pradesh' },
            { code: 'MH', name: 'Maharashtra' }, { code: 'MN', name: 'Manipur' },
            { code: 'ML', name: 'Meghalaya' }, { code: 'MZ', name: 'Mizoram' },
            { code: 'NL', name: 'Nagaland' }, { code: 'OD', name: 'Odisha' },
            { code: 'PB', name: 'Punjab' }, { code: 'RJ', name: 'Rajasthan' },
            { code: 'SK', name: 'Sikkim' }, { code: 'TN', name: 'Tamil Nadu' },
            { code: 'TS', name: 'Telangana' }, { code: 'TR', name: 'Tripura' },
            { code: 'UP', name: 'Uttar Pradesh' }, { code: 'UK', name: 'Uttarakhand' },
            { code: 'WB', name: 'West Bengal' }, { code: 'AN', name: 'Andaman and Nicobar' },
            { code: 'CH', name: 'Chandigarh' }, { code: 'DD', name: 'Dadra and Nagar Haveli and Daman and Diu' },
            { code: 'DL', name: 'Delhi' }, { code: 'LA', name: 'Ladakh' },
            { code: 'LD', name: 'Lakshadweep' }, { code: 'PY', name: 'Puducherry' }
        ];
        
        const stateOptions = indianStates.map(state => 
            `<option value="${state.code}">${state.name} (${state.code})</option>`
        ).join('');

        function selectTask(task) {
            document.querySelectorAll('.task-card').forEach(c => c.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            selectedTask = task;
            sessionData = {};
            
            const formSection = document.getElementById('formSection');
            formSection.classList.add('active');
            
            if (task === 'search') {
                showSearchStep1();
            } else if (task === 'register') {
                showRegisterStep1();
            } else if (task === 'transfer') {
                showTransferStep1();
            } else if (task === 'update') {
                showUpdateStep1();
            } else {
                showStatus('This feature is coming soon!', 'info');
            }
        }

        // === SEARCH VEHICLE FLOW ===
        function showSearchStep1() {
            document.getElementById('formSection').innerHTML = `
                <h3>üîç Know Your Vehicle - Step 1</h3>
                <div class="form-group">
                    <label>Vehicle Registration Number *</label>
                    <input type="text" id="search_regNo" placeholder="e.g., DL01AB1234" style="text-transform: uppercase;">
                </div>
                <div class="form-group">
                    <label>State *</label>
                    <select id="search_state">
                        <option value="">-- Select State --</option>
                        ${stateOptions}
                    </select>
                </div>
                <button class="btn" onclick="searchStep1()">üîÑ Get Captcha</button>
                <div class="status-message" id="statusMsg"></div>
            `;
        }
        async function searchStep1() {
            const regNo = document.getElementById('search_regNo').value.trim();
            const state = document.getElementById('search_state').value;
            if (!regNo || !state) {
                showStatus('Please fill all fields', 'error'); return;
            }
            sessionData.regNo = regNo.toUpperCase();
            sessionData.state = state;
            showStatus('üîÑ Opening VAHAN portal invisibly and fetching captcha...', 'info');
            const result = await callAutomation('search', { 
                regNo: sessionData.regNo, 
                state: sessionData.state 
            });
            if (result.success && result.needsCaptcha) {
                sessionData.sessionId = result.sessionId;
                showSearchStep2(result.captchaImageBase64);
            } else {
                showStatus('‚ùå Error: ' + result.message, 'error');
            }
        }
        function showSearchStep2(captchaImage) {
            document.getElementById('formSection').innerHTML = `
                <h3>üîç Know Your Vehicle - Step 2</h3>
                <p><strong>Vehicle:</strong> ${sessionData.regNo} | <strong>State:</strong> ${sessionData.state}</p>
                <div class="form-group">
                    <label>Enter Captcha Code *</label>
                    <div class="captcha-container">
                        <img src="${captchaImage}" class="captcha-image" alt="Captcha">
                    </div>
                    <input type="text" id="captcha_input" placeholder="Enter captcha" maxlength="6" style="text-align: center; font-size: 18px; letter-spacing: 5px;">
                </div>
                <button class="btn" onclick="searchStep2()">üîç Search Vehicle</button>
                <div class="status-message" id="statusMsg"></div>
            `;
            document.getElementById('captcha_input').focus();
        }
        async function searchStep2() {
            const captcha = document.getElementById('captcha_input').value.trim();
            if (!captcha) {
                showStatus('Please enter captcha', 'error'); return;
            }
            showStatus('üîÑ Submitting and fetching vehicle details...', 'info');
            const result = await callAutomation('search', {
                regNo: sessionData.regNo,
                state: sessionData.state,
                captcha: captcha.toUpperCase(),
                sessionId: sessionData.sessionId
            });
            if (result.success) {
                showSearchResult(result.data);
            } else {
                showStatus('‚ùå Error: ' + result.message, 'error');
            }
        }
        function showSearchResult(data) {
             document.getElementById('formSection').innerHTML = `
                <div class="result-box">
                    <h4>‚úÖ Vehicle Details Retrieved Successfully</h4>
                    <table class="result-table">
                        <tr><td>Registration Number</td><td><strong>${data.regNo}</strong></td></tr>
                        <tr><td>Owner Name</td><td><strong>${data.ownerName}</strong></td></tr>
                        <tr><td>Maker/Model</td><td><strong>${data.model}</strong></td></tr>
                        <tr><td>RTO</td><td>${data.rto}</td></tr>
                        <tr><td>Registration Date</td><td>${data.regDate}</td></tr>
                        <tr><td>Vehicle Class</td><td>${data.class}</td></tr>
                        <tr><td>Fuel Type</td><td>${data.fuel}</td></tr>
                        <tr><td>Insurance Upto</td><td>${data.insUpto}</td></tr>
                        <tr><td>Address</td><td>${data.address}</td></tr>
                    </table>
                </div>
                <button class="btn" onclick="location.reload()">üîÑ New Search</button>
            `;
        }


        // === VEHICLE REGISTRATION FLOW ===
        function showRegisterStep1() {
            document.getElementById('formSection').innerHTML = `
                <h3>üìã Vehicle Registration - Step 1: Login</h3>
                <div class="form-group">
                    <label>Your Email Address *</label>
                    <input type="email" id="reg_email" placeholder="e.g., user@example.com">
                </div>
                <button class="btn" onclick="registerStep1()">Send OTP</button>
                <div class="status-message" id="statusMsg"></div>
            `;
        }
        async function registerStep1() {
            const email = document.getElementById('reg_email').value.trim();
            if (!email) {
                showStatus('Please enter an email address', 'error'); return;
            }
            sessionData.email = email;
            showStatus('üîÑ Contacting VAHAN portal to send OTP...', 'info');
            const result = await callAutomation('register', { email: email });
            if (result.success && result.step === 'otp_sent') {
                sessionData.sessionId = result.sessionId;
                showRegisterStep2();
            } else {
                showStatus('‚ùå Error: ' + result.message, 'error');
            }
        }
        function showRegisterStep2() {
            document.getElementById('formSection').innerHTML = `
                <h3>üìã Vehicle Registration - Step 2: Verify OTP</h3>
                <p>An OTP has been sent to <strong>${sessionData.email}</strong>. Please enter it below.</p>
                <div class="form-group">
                    <label>Enter 6-Digit OTP *</label>
                    <input type="text" id="reg_otp" placeholder="123456" maxlength="6" style="text-align: center; font-size: 18px; letter-spacing: 5px;">
                </div>
                <button class="btn" onclick="registerStep2()">Verify OTP & Login</button>
                <div class="status-message" id="statusMsg"></div>
            `;
            document.getElementById('reg_otp').focus();
        }
        async function registerStep2() {
            const otp = document.getElementById('reg_otp').value.trim();
            if (!otp) {
                showStatus('Please enter the OTP', 'error'); return;
            }
            showStatus('üîÑ Verifying OTP and logging in...', 'info');
            const result = await callAutomation('register', {
                sessionId: sessionData.sessionId,
                email: sessionData.email,
                otp: otp
            });
            if (result.success && result.step === 'logged_in') {
                showRegisterStep3();
            } else {
                showStatus('‚ùå Error: ' + result.message, 'error');
            }
        }
        function showRegisterStep3() {
            document.getElementById('formSection').innerHTML = `
                <h3>üìã Vehicle Registration - Step 3: Vehicle Details</h3>
                <p style="color: #4caf50;"><strong>Login successful!</strong> Please enter the new vehicle details.</p>
                <h4>Owner Details</h4>
                <div class="form-row">
                    <div class="form-group"><label>Owner Name *</label><input type="text" id="reg_ownerName" placeholder="Full Name"></div>
                    <div class="form-group"><label>Father/Husband Name *</label><input type="text" id="reg_fatherName" placeholder="Father's Name"></div>
                </div>
                <div class="form-group"><label>Mobile Number *</label><input type="tel" id="reg_mobile" placeholder="9876543210" pattern="[0-9]{10}"></div>
                <div class="form-group"><label>Address *</label><textarea id="reg_address" rows="3" placeholder="Full Address"></textarea></div>
                <h4>Vehicle Details</h4>
                <div class="form-row">
                    <div class="form-group"><label>Vehicle Class *</label><input type="text" id="reg_vehicleClass" placeholder="e.g., Motor Car"></div>
                    <div class="form-group"><label>Maker / Model *</label><input type="text" id="reg_model" placeholder="e.g., MARUTI SUZUKI SWIFT VXI"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Fuel Type *</label><select id="reg_fuel"><option>Petrol</option><option>Diesel</option><option>CNG</option><option>Electric</option></select></div>
                    <div class="form-group"><label>Color *</label><input type="text" id="reg_color" placeholder="e.g., White"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Ex-Showroom Price (‚Çπ) *</label><input type="number" id="reg_price" placeholder="500000"></div>
                    <div class="form-group"><label>Select RTO / State *</label><select id="reg_rto"><option value="">-- Select State --</option>${stateOptions}</select></div>
                </div>
                <button class="btn" onclick="registerStep3()">Submit Registration</button>
                <div class="status-message" id="statusMsg"></div>
            `;
        }
        async function registerStep3() {
            const vehicleData = {
                ownerName: document.getElementById('reg_ownerName').value,
                fatherName: document.getElementById('reg_fatherName').value,
                mobile: document.getElementById('reg_mobile').value,
                address: document.getElementById('reg_address').value,
                vehicleClass: document.getElementById('reg_vehicleClass').value,
                model: document.getElementById('reg_model').value,
                fuel: document.getElementById('reg_fuel').value,
                color: document.getElementById('reg_color').value,
                price: document.getElementById('reg_price').value,
                rto: document.getElementById('reg_rto').value
            };
            for (let key in vehicleData) {
                if (!vehicleData[key]) {
                    showStatus(`Please fill in all fields. "${key}" is missing.`, 'error'); return;
                }
            }
            showStatus('üîÑ Submitting registration... This may take a moment.', 'info');
            const result = await callAutomation('register', {
                sessionId: sessionData.sessionId,
                ...vehicleData
            });
            if (result.success && result.step === 'completed') {
                showResult(result.data);
            } else {
                showStatus('‚ùå Error: ' + result.message, 'error');
            }
        }


        // === TRANSFER OWNERSHIP FLOW ===
        function showTransferStep1() {
            document.getElementById('formSection').innerHTML = `
                <h3>üîÑ Transfer Ownership - Step 1: Login</h3>
                <p>Enter your email to log in as the <strong>current owner</strong>.</p>
                <div class="form-group">
                    <label>Your Email Address *</label>
                    <input type="email" id="transfer_email" placeholder="e.g., current.owner@example.com">
                </div>
                <button class="btn" onclick="transferStep1()">Send OTP</button>
                <div class="status-message" id="statusMsg"></div>
            `;
        }
        async function transferStep1() {
            const email = document.getElementById('transfer_email').value.trim();
            if (!email) {
                showStatus('Please enter an email address', 'error'); return;
            }
            sessionData.email = email;
            showStatus('üîÑ Contacting VAHAN portal to send OTP...', 'info');
            const result = await callAutomation('transfer', { email: email });
            if (result.success && result.step === 'otp_sent') {
                sessionData.sessionId = result.sessionId;
                showTransferStep2();
            } else {
                showStatus('‚ùå Error: ' + result.message, 'error');
            }
        }
        function showTransferStep2() {
            document.getElementById('formSection').innerHTML = `
                <h3>üîÑ Transfer Ownership - Step 2: Verify OTP</h3>
                <p>An OTP has been sent to <strong>${sessionData.email}</strong>. Please enter it below.</p>
                <div class="form-group">
                    <label>Enter 6-Digit OTP *</label>
                    <input type="text" id="transfer_otp" placeholder="123456" maxlength="6" style="text-align: center; font-size: 18px; letter-spacing: 5px;">
                </div>
                <button class="btn" onclick="transferStep2()">Verify OTP & Login</button>
                <div class="status-message" id="statusMsg"></div>
            `;
            document.getElementById('transfer_otp').focus();
        }
        async function transferStep2() {
            const otp = document.getElementById('transfer_otp').value.trim();
            if (!otp) {
                showStatus('Please enter the OTP', 'error'); return;
            }
            showStatus('üîÑ Verifying OTP and logging in...', 'info');
            const result = await callAutomation('transfer', {
                sessionId: sessionData.sessionId,
                email: sessionData.email,
                otp: otp
            });
            if (result.success && result.step === 'logged_in') {
                showTransferStep3();
            } else {
                showStatus('‚ùå Error: ' + result.message, 'error');
            }
        }
        function showTransferStep3() {
            document.getElementById('formSection').innerHTML = `
                <h3>üîÑ Transfer Ownership - Step 3: Find Vehicle</h3>
                <p style="color: #4caf50;"><strong>Login successful!</strong></p>
                <p>Enter the details of the vehicle you want to transfer.</p>
                <div class="form-group">
                    <label>Vehicle Registration Number *</label>
                    <input type="text" id="transfer_regNo" placeholder="e.g., DL01AB1234" style="text-transform: uppercase;">
                </div>
                <div class="form-group">
                    <label>State *</label>
                    <select id="transfer_state">
                        <option value="">-- Select State --</option>
                        ${stateOptions}
                    </select>
                </div>
                <button class="btn" onclick="transferStep3()">Find Vehicle</button>
                <div class="status-message" id="statusMsg"></div>
            `;
        }
        async function transferStep3() {
            const regNo = document.getElementById('transfer_regNo').value.trim().toUpperCase();
            const state = document.getElementById('transfer_state').value;
            if (!regNo || !state) {
                showStatus('Please fill all fields', 'error'); return;
            }
            sessionData.regNo = regNo;
            sessionData.state = state;
            showStatus('üîÑ Finding vehicle and getting search captcha...', 'info');
            const result = await callAutomation('transfer', {
                sessionId: sessionData.sessionId,
                regNo: regNo,
                state: state
            });
            if (result.success && result.step === 'search_captcha_sent') {
                sessionData.captchaImageBase64 = result.captchaImageBase64;
                showTransferStep4(result.captchaImageBase64);
            } else {
                showStatus('‚ùå Error: ' + result.message, 'error');
            }
        }
        function showTransferStep4(captchaImage) {
            document.getElementById('formSection').innerHTML = `
                <h3>üîÑ Transfer Ownership - Step 4: Verify Search</h3>
                <p><strong>Vehicle:</strong> ${sessionData.regNo}</p>
                <div class="form-group">
                    <label>Enter Search Captcha *</label>
                    <div class="captcha-container">
                        <img src="${captchaImage}" class="captcha-image" alt="Captcha">
                    </div>
                    <input type="text" id="transfer_search_captcha" placeholder="Enter captcha" maxlength="6" style="text-align: center; font-size: 18px; letter-spacing: 5px;">
                </div>
                <button class="btn" onclick="transferStep4()">Find Vehicle</button>
                <div class="status-message" id="statusMsg"></div>
            `;
            document.getElementById('transfer_search_captcha').focus();
        }
        async function transferStep4() {
            const searchCaptcha = document.getElementById('transfer_search_captcha').value.trim().toUpperCase();
            if (!searchCaptcha) {
                showStatus('Please enter the search captcha', 'error'); return;
            }
            showStatus('üîÑ Submitting search and opening transfer form...', 'info');
            const result = await callAutomation('transfer', {
                sessionId: sessionData.sessionId,
                regNo: sessionData.regNo,
                state: sessionData.state,
                searchCaptcha: searchCaptcha
            });
            if (result.success && result.step === 'modal_open') {
                showTransferStep5();
            } else {
                showStatus('‚ùå Error: ' + result.message, 'error');
            }
        }
        function showTransferStep5() {
            document.getElementById('formSection').innerHTML = `
                <h3>üîÑ Transfer Ownership - Step 5: New Owner Details</h3>
                <p style="color: #4caf50;"><strong>Vehicle found!</strong> Please enter the new owner's details.</p>
                <h4>New Owner Details</h4>
                <div class="form-row">
                    <div class="form-group"><label>New Owner Name *</label><input type="text" id="trans_newOwnerName" placeholder="Full Name"></div>
                    <div class="form-group"><label>Father/Husband Name *</label><input type="text" id="trans_newOwnerFather" placeholder="Father's Name"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Mobile Number *</label><input type="tel" id="trans_newOwnerMobile" placeholder="9876543210" pattern="[0-9]{10}"></div>
                    <div class="form-group"><label>Email (for New Owner's Login) *</label><input type="email" id="trans_newOwnerEmail" placeholder="new.owner@example.com"></div>
                </div>
                <div class="form-group"><label>Address *</label><textarea id="trans_newOwnerAddress" rows="3" placeholder="New Owner's Full Address"></textarea></div>
                <div class="form-group"><label>Sale Amount (‚Çπ) *</label><input type="number" id="trans_saleAmount" placeholder="500000"></div>
                
                <button class="btn" onclick="transferStep5()">Submit Transfer Application</button>
                <div class="status-message" id="statusMsg"></div>
            `;
        }
        async function transferStep5() {
            const transferData = {
                newOwnerName: document.getElementById('trans_newOwnerName').value,
                newOwnerFather: document.getElementById('trans_newOwnerFather').value,
                newOwnerMobile: document.getElementById('trans_newOwnerMobile').value,
                newOwnerEmail: document.getElementById('trans_newOwnerEmail').value,
                newOwnerAddress: document.getElementById('trans_newOwnerAddress').value,
                saleAmount: document.getElementById('trans_saleAmount').value
            };
            for (let key in transferData) {
                if (!transferData[key]) {
                    showStatus(`Please fill in all fields. "${key}" is missing.`, 'error'); return;
                }
            }
            showStatus('üîÑ Submitting final application... This may take a moment.', 'info');
            const result = await callAutomation('transfer', {
                sessionId: sessionData.sessionId,
                ...transferData
            });
            if (result.success && result.step === 'completed') {
                showResult(result.data);
            } else {
                showStatus('‚ùå Error: ' + result.message, 'error');
            }
        }

        
        // === NEW: UPDATE CONTACTS FLOW ===
        function showUpdateStep1() {
            document.getElementById('formSection').innerHTML = `
                <h3>‚úèÔ∏è Update Contacts - Step 1: Login</h3>
                <p>Enter your email to log in.</p>
                <div class="form-group">
                    <label>Your Email Address *</label>
                    <input type="email" id="update_email" placeholder="e.g., user@example.com">
                </div>
                <button class="btn" onclick="updateStep1()">Send OTP</button>
                <div class="status-message" id="statusMsg"></div>
            `;
        }

        async function updateStep1() {
            const email = document.getElementById('update_email').value.trim();
            if (!email) {
                showStatus('Please enter an email address', 'error'); return;
            }
            sessionData.email = email;
            showStatus('üîÑ Contacting VAHAN portal to send OTP...', 'info');
            const result = await callAutomation('update', { email: email });
            if (result.success && result.step === 'otp_sent') {
                sessionData.sessionId = result.sessionId;
                showUpdateStep2();
            } else {
                showStatus('‚ùå Error: ' + result.message, 'error');
            }
        }

        function showUpdateStep2() {
            document.getElementById('formSection').innerHTML = `
                <h3>‚úèÔ∏è Update Contacts - Step 2: Verify OTP</h3>
                <p>An OTP has been sent to <strong>${sessionData.email}</strong>. Please enter it below.</p>
                <div class="form-group">
                    <label>Enter 6-Digit OTP *</label>
                    <input type="text" id="update_otp" placeholder="123456" maxlength="6" style="text-align: center; font-size: 18px; letter-spacing: 5px;">
                </div>
                <button class="btn" onclick="updateStep2()">Verify OTP & Login</button>
                <div class="status-message" id="statusMsg"></div>
            `;
            document.getElementById('update_otp').focus();
        }

        async function updateStep2() {
            const otp = document.getElementById('update_otp').value.trim();
            if (!otp) {
                showStatus('Please enter the OTP', 'error'); return;
            }
            showStatus('üîÑ Verifying OTP and logging in...', 'info');
            const result = await callAutomation('update', {
                sessionId: sessionData.sessionId,
                email: sessionData.email,
                otp: otp
            });
            if (result.success && result.step === 'logged_in') {
                showUpdateStep3();
            } else {
                showStatus('‚ùå Error: ' + result.message, 'error');
            }
        }

        function showUpdateStep3() {
            document.getElementById('formSection').innerHTML = `
                <h3>‚úèÔ∏è Update Contacts - Step 3: Find Vehicle</h3>
                <p style="color: #4caf50;"><strong>Login successful!</strong></p>
                <p>Enter the details of the vehicle you want to update.</p>
                <div class="form-group">
                    <label>Vehicle Registration Number *</label>
                    <input type="text" id="update_regNo" placeholder="e.g., DL01AB1234" style="text-transform: uppercase;">
                </div>
                <div class="form-group">
                    <label>State *</label>
                    <select id="update_state">
                        <option value="">-- Select State --</option>
                        ${stateOptions}
                    </select>
                </div>
                <button class="btn" onclick="updateStep3()">Find Vehicle</button>
                <div class="status-message" id="statusMsg"></div>
            `;
        }

        async function updateStep3() {
            const regNo = document.getElementById('update_regNo').value.trim().toUpperCase();
            const state = document.getElementById('update_state').value;
            if (!regNo || !state) {
                showStatus('Please fill all fields', 'error'); return;
            }
            sessionData.regNo = regNo;
            sessionData.state = state;
            showStatus('üîÑ Finding vehicle and getting search captcha...', 'info');
            const result = await callAutomation('update', {
                sessionId: sessionData.sessionId,
                regNo: regNo,
                state: state
            });
            if (result.success && result.step === 'search_captcha_sent') {
                sessionData.captchaImageBase64 = result.captchaImageBase64;
                showUpdateStep4(result.captchaImageBase64);
            } else {
                showStatus('‚ùå Error: ' + result.message, 'error');
            }
        }

        function showUpdateStep4(captchaImage) {
            document.getElementById('formSection').innerHTML = `
                <h3>‚úèÔ∏è Update Contacts - Step 4: Verify Search</h3>
                <p><strong>Vehicle:</strong> ${sessionData.regNo}</p>
                <div class="form-group">
                    <label>Enter Search Captcha *</label>
                    <div class="captcha-container">
                        <img src="${captchaImage}" class="captcha-image" alt="Captcha">
                    </div>
                    <input type="text" id="update_search_captcha" placeholder="Enter captcha" maxlength="6" style="text-align: center; font-size: 18px; letter-spacing: 5px;">
                </div>
                <button class="btn" onclick="updateStep4()">Find Vehicle</button>
                <div class="status-message" id="statusMsg"></div>
            `;
            document.getElementById('update_search_captcha').focus();
        }

        async function updateStep4() {
            const searchCaptcha = document.getElementById('update_search_captcha').value.trim().toUpperCase();
            if (!searchCaptcha) {
                showStatus('Please enter the search captcha', 'error'); return;
            }
            showStatus('üîÑ Submitting search and opening update form...', 'info');
            const result = await callAutomation('update', {
                sessionId: sessionData.sessionId,
                regNo: sessionData.regNo,
                state: sessionData.state,
                searchCaptcha: searchCaptcha
            });
            if (result.success && result.step === 'modal_open') {
                showUpdateStep5();
            } else {
                showStatus('‚ùå Error: ' + result.message, 'error');
            }
        }

        function showUpdateStep5() {
            document.getElementById('formSection').innerHTML = `
                <h3>‚úèÔ∏è Update Contacts - Step 5: New Details</h3>
                <p style="color: #4caf50;"><strong>Vehicle found!</strong> Please enter the new details.</p>
                <p style="color: #666; font-size: 13px; margin-bottom: 20px;">
                    Your login email (<strong>${sessionData.email}</strong>) will be used automatically.
                </p>
                <div class="form-group">
                    <label>New Address *</label>
                    <textarea id="update_newAddress" rows="3" placeholder="New Full Address"></textarea>
                </div>
                <div class="form-group">
                    <label>New Mobile Number *</label>
                    <input type="tel" id="update_newMobile" placeholder="9876543210" pattern="[0-9]{10}">
                </div>
                
                <button class="btn" onclick="updateStep5()">Submit Update</button>
                <div class="status-message" id="statusMsg"></div>
            `;
        }

        async function updateStep5() {
            const updateData = {
                newAddress: document.getElementById('update_newAddress').value,
                newMobile: document.getElementById('update_newMobile').value,
            };

            for (let key in updateData) {
                if (!updateData[key]) {
                    showStatus(`Please fill in all fields. "${key}" is missing.`, 'error'); return;
                }
            }

            showStatus('üîÑ Submitting final update... This may take a moment.', 'info');
            
            const result = await callAutomation('update', {
                sessionId: sessionData.sessionId,
                ...updateData
            });

            if (result.success && result.step === 'completed') {
                showResult(result.data);
            } else {
                showStatus('‚ùå Error: ' + result.message, 'error');
            }
        }

        
        // === HELPER FUNCTIONS ===
        async function callAutomation(taskType, data) {
            try {
                const response = await fetch('http://localhost:5000/api/automation/execute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ taskType, ...data })
                });
                return await response.json();
            } catch (error) {
                return { success: false, message: error.message };
            }
        }

        function showStatus(message, type) {
            const statusEl = document.getElementById('statusMsg');
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.className = 'status-message show ' + type;
            }
        }

        function showResult(data) {
            let content;
            if (selectedTask === 'register') {
                content = `
                    <h4>‚úÖ Vehicle Registered Successfully!</h4>
                    <table class="result-table">
                        <tr><td>Status</td><td><strong>${data.status}</strong></td></tr>
                        <tr><td>New Registration No.</td><td><strong>${data.registrationNumber}</strong></td></tr>
                        <tr><td>Application ID</td><td>${data.applicationId}</td></tr>
                        <tr><td>Owner Name</td><td>${data.ownerName}</td></tr>
                        <tr><td>Model</td><td>${data.model}</td></tr>
                    </table>
                `;
            } else if (selectedTask === 'transfer') {
                 content = `
                    <h4>‚úÖ Ownership Transferred Successfully!</h4>
                    <table class="result-table">
                        <tr><td>Status</td><td><strong>${data.status}</strong></td></tr>
                        <tr><td>Application ID</td><td><strong>${data.applicationId}</strong></td></tr>
                        <tr><td>Vehicle Reg. No.</td><td>${data.vehicleRegNo}</td></tr>
                        <tr><td>New Owner</td><td>${data.newOwner}</td></tr>
                    </table>
                `;
            } else if (selectedTask === 'update') {
                 content = `
                    <h4>‚úÖ Contact Details Updated Successfully!</h4>
                    <table class="result-table">
                        <tr><td>Status</td><td><strong>${data.status}</strong></td></tr>
                        <tr><td>Application ID</td><td><strong>${data.applicationId}</strong></td></tr>
                        <tr><td>Vehicle Reg. No.</td><td>${data.vehicleRegNo}</td></tr>
                        <tr><td>New Address</td><td>${data.newAddress}</td></tr>
                        <tr><td>New Mobile</td><td>${data.newMobile}</td></tr>
                    </table>
                `;
            } else {
                // Fallback for Search Task
                 content = `
                    <h4>‚úÖ Vehicle Details Retrieved Successfully</h4>
                    <table class="result-table">
                        <tr><td>Registration Number</td><td><strong>${data.regNo}</strong></td></tr>
                        <tr><td>Owner Name</td><td><strong>${data.ownerName}</strong></td></tr>
                        <tr><td>Maker/Model</td><td><strong>${data.model}</strong></td></tr>
                        <tr><td>RTO</td><td>${data.rto}</td></tr>
                        <tr><td>Registration Date</td><td>${data.regDate}</td></tr>
                        <tr><td>Vehicle Class</td><td>${data.class}</td></tr>
                        <tr><td>Fuel Type</td><td>${data.fuel}</td></tr>
                        <tr><td>Insurance Upto</td><td>${data.insUpto}</td></tr>
                        <tr><td>Address</td><td>${data.address}</td></tr>
                    </table>
                `;
            }

            document.getElementById('formSection').innerHTML = `
                <div class="result-box">
                    ${content}
                </div>
                <button class="btn" onclick="location.reload()">üîÑ Start New Task</button>
            `;
        }
    </script>
</body>
</html>